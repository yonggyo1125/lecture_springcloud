# 나쁜 상황에 대비한 스프링 클라우드와 Resilience4j를 사용한 회복성 패턴 

- 모든 시스템, 특히 분산 시스템은 실패를 겪는다. 이러한 실패에 대응하는 애플리케이션을 구축하는 방법은 모든 소프트웨어 개발자의 업무에서 중요한 부분이다. 하지만 <code>회복성(resilience)</code>을 갖춘 시스템을 구축할 때 소프트웨어 엔지니어 대부분은 인프라스트럭처나 중요 서비스의 한 부분이 완전히 실패한 경우만 고려한다. 그들은 핵심 서버의 클러스터링, 서비스의 로드 밸런싱, 인프라스트럭처를 여러 곳에 분리하는 것 등의 기술을 사용하여 애플리케이션 각 계층에 중복성(redundancy)을 만드는 데 집중한다.

- 이러한 접근 방식에서는 시스템 구성 요소가 완전히(대개 엄청나게) 손상될 것을 고려하지만, 회복력 있는 시스템 구축에 대한 작은 한 부분의 문제만 해결할 뿐이다. 서비스가 망가지면 쉽게 감지할 수 있고 애플리케이션은 이를 우회할 수 있다. 하지만 서비스가 느려진다면 성능 저하를 감지하고 우회하는 일은 다음 이유로 매우 어렵다.
    - **서비스 성능 저하는 간헐적으로 시작되어 확산될 수 있다**: 서비스 저하도 작은 곳에서 갑자기 발생할 수 있다. 순식간에 애플리케이션 컨테이너의 스레드 풀이 완전히 소진되고 붕괴되기 전까지, 실패의 첫 징후는 소규모 사용자가 문제에 대해 불평하는 정도로 나타날 수 있다.
    - **원격 서비스 호출은 대개 동기식이며 장기간 수행되는 호출을 중단하지 않는다**: 일반적으로 애플리케이션 개발자는 작업을 수행하려고 서비스를 호출하고 결과를 기다린다. 호출자에게는 서비스 호출이 행(hanging)되는 것을 방지하는 타임아웃 개념이 없다.
    - **대개 원격 자원의 부분적인 저하가 아닌 완전한 실패를 처리하도록 애플리케이션을 설계한다**: 서비스가 완전히 실패하지 않는 한 애플리케이션은 계속해서 불량한 서비스를 호출하고 빠르게 실패하지 못하는 경우가 많다. 이때 호출하는 애플리케이션이나 서비스는 정상적으로 성능이 저하될 수도 있지만, 자원 고갈로 고장 날 가능성이 더 높다. 자원 고갈(resource exhaustion)이란 스레드 풀이나 데이터베이스 커넥션 같은 제한된 자원이 초과 사용되어 호출 클라이언트가 자원이 다시 가용해질 때까지 대기해야 하는 상황이다.
- 성능이 나쁜 원격 서비스가 야기하는 문제를 간과할 수 없는 것은 이를 탐지하기 어려울 뿐만 아니라 전체 애플리케이션 생태계에 파급되는 연쇄 효과를 유발할 수 있기 때문이다. 보호 장치가 없다면 불량한 서비스 하나가 빠르게 여러 애플리케이션을 다운시킬 수 있다. 클라우드 기반이면서 마이크로서비스 기반 애플리케이션이 이러한 유형의 장애에 특히 취약한 이유는 사용자 트랜잭션을 완료하는 데 연관된 다양한 인프라스트럭처와 함께 다수의 세분화된 서비스로 구성되기 때문이다.
- 회복성 패턴은 마이크로서비스 아키텍처에서 가장 중요한 요소 중 하나다.


## 클라이언트 측 회복성이란?

> 클라이언트 측 회복성 소프트웨어 패턴들은 에러나 성능 저하로 원격 자원이 실패할 때 원격 자원의 클라이언트가 고장 나지 않게 보호하는 데 중점을 둔다. 이들 패턴을 사용하면 클라이언트가 빨리 실패하고 데이터베이스 커넥션과 스레드 풀 같은 소중한 자원을 소비하는 것을 방지할 수 있다. 또한 제대로 성능이 낮은 원격 서비스 문제가 소비자에게 ‘상향(upstream)’으로 확산되는 것을 막는다. 

![image1](https://raw.githubusercontent.com/yonggyo1125/lecture_springcloud/master/5.%20%EB%82%98%EC%81%9C%20%EC%83%81%ED%99%A9%EC%97%90%20%EB%8C%80%EB%B9%84%ED%95%9C%20%EC%8A%A4%ED%94%84%EB%A7%81%20%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EC%99%80%20Resilience4j%EB%A5%BC%20%EC%82%AC%EC%9A%A9%ED%95%9C%20%ED%9A%8C%EB%B3%B5%EC%84%B1%20%ED%8C%A8%ED%84%B4/images/1.png)
> 네 가지 클라이언트 회복성 패턴은 서비스 소비자와 서비스 사이에서 보호대 역할을 한다.



## 클라이언트 회복성이 중요한 이유?

## Resilience4j 구현

## 스프링 클라우드와 Resilience4j를 사용하는 라이선싱 서비스 설정

## 회로 차단기 구현

## 폴백 처리

## 벌크헤드 패턴 구현

## 재시도 패턴 구현

## 속도 제한기 패턴 구현

## ThreadLocal과 Resilience4J 