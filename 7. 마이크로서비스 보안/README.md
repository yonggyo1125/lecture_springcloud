# 마이크로 서비스 보안 

- 견고한 마이크로서비스 아키텍처를 갖게 되면서 보안 취약점을 막는 작업은 점점 더 중요해지고 있다. 이 장에서는 보안과 취약점을 함께 다룬다. 취약점을 애플리케이션의 약점이나 결함으로 정의할 것이다. 물론 모든 시스템에는 취약점이 존재하지만, 이러한 취약점이 악용되고 피해를 주는지에 따라 큰 차이가 있다.
- 보안을 언급하면 개발자는 무의식적으로 한숨을 내쉴 때가 많다. 개발자에게서 “보안은 막연하고 이해하기 어려우며 디버깅하는 것은 더 어려워요.”라는 하소연을 듣는다. 하지만 필자는 보안을 걱정하지 않는다고 말하는 개발자(아마도 신출내기 개발자를 제외하고)를 여태껏 보지 못했다. 마이크로서비스 아키텍처를 안전하게 보호하는 일은 다음과 같은 여러 보호 계층과 연관되어 복잡하고 힘든 작업이다.
  - **애플리케이션 계층**: 적절하게 사용자를 통제하여 사용자 본인 여부와 수행하려는 작업의 수행 권한이 있는지 확인한다.
  - **인프라스트럭처**: 취약점의 위험도를 최소화하도록 서비스를 항상 실행하고 패치하고 최신화한다.
  - **네트워크 계층**: 서비스가 명확히 정의된 포트를 통해 인가된 소수의 서버에만 접근할 수 있도록 네트워크 접근 통제를 구현한다.

- 인증 및 권한 부여(인가) 제어를 구현하는 데 스프링 기반의 서비스를 보호하는 <code>스프링 클라우드 시큐리티(Security) 모듈</code>과 <code>키클록(Keycloak)</code>을 사용할 수 있다. 키클록은 최신 애플리케이션 및 서비스를 위한 ID 및 액세스 관리(identity and access management)용 오픈 소스 소프트웨어다. 이 오픈 소스 소프트웨어는 자바로 작성되었고 SAML(Security Assertion Markup Language) v2와 OpenID Connect(OIDC)/OAuth2 연합 ID(federated identity) 프로토콜을 지원한다.

## OAuth2 소개

- OAuth2는 토큰 기반의 보안 프레임워크로 권한 부여 패턴을 설명하지만 실제 인증을 수행하는 방법은 정의하지 않는다. 따라서 사용자는 ID 제공자(IdP, Identity provider)라고 하는 제삼자(3rd party) 인증 서비스로 자신을 인증할 수 있다. 사용자는 인증에 성공하면 모든 요청과 함께 전달할 토큰을 제공받고 인증 서비스에 이 토큰의 유효성을 확인한다.

- OAuth2의 주요 목적은 사용자 요청을 수행하기 위해 여러 서비스를 호출할 때, 요청을 처리하는 모든 서비스에 자격 증명(credentials)을 제시하지 않고도 각 서비스에서 사용자를 인증하는 것이다. OAuth2를 사용하면 그랜트(grants)라는 인증 체계를 통해 REST 기반의 서비스를 보호할 수 있다. OAuth2 명세에는 네 가지 그랜트 타입이 있다.
  - 패스워드(password)
  - 클라이언트 자격 증명(client credential)
  - 인가 코드(authorization code)
  - 암시적(implicit)
- 그랜트 타입을 모두 살펴보거나 예제를 제공하기는 너무 많아서 대신에 다음 사항을 다룰 것이다. 
  - 비교적 단순한 OAuth2 그랜트 타입인 패스워드(password) 그랜트 타입으로 마이크로서비스에서 OAuth2 사용 방법을 논의한다.
  - JWT(JSON Web Tokens)를 사용하여 더욱 안전한 OAuth2 솔루션을 제공하고 OAuth2 토큰 정보를 인코딩하는 표준을 만든다.
  - 마이크로서비스를 구축할 때 고려해야 할 다른 보안 사항을 살펴본다.

- OAuth2의 진정한 강점은 애플리케이션 개발자가 제삼자 ID 제공자와 쉽게 통합할 수 있으며, 자격 증명을 제삼자 서비스에 계속 전달하지 않고도 해당 서비스에서 사용자를 인증하고 인가할 수 있다는 것이다.
- OpenID Connect(OIDC)는 OAuth2 프레임워크에 기반을 둔 상위 계층으로 애플리케이션에 로그인한 사람(신원)에 대한 인증 및 프로파일 정보를 제공한다. 인가(authorization) 서버가 OIDC를 지원하는 경우, ID 제공자(identity provider)라고도 한다. 그럼 서비스를 보호하는 기술적 세부 사항을 설명하기 전에 키클록 아키텍처를 먼저 살펴보자.

---

## 키클록 소개
- 키클록(Keycloak)은 서비스와 애플리케이션을 위한 ID 및 액세스 관리용 오픈 소스 솔루션이다. 키클록의 주요 목표는 서비스와 애플리케이션의 코딩을 전혀 또는 거의 하지 않고 서비스와 애플리케이션을 쉽게 보호하는 것이다. 키클록의 주요 특징은 다음과 같다.
  - 인증을 중앙 집중화하고 SSO(Single Sign-On) 인증을 가능하게 한다.
  - 개발자는 인가와 인증처럼 보안 측면에 대해 걱정하기보다는 비즈니스 기능에 집중할 수 있다.
  - 2단계 인증(two-factor authentication)이 가능하다.
  - LDAP과 호환된다.
  - 애플리케이션과 서버를 쉽게 보호할 수 있는 여러 어댑터를 제공한다.
  - 패스워드 정책을 재정의할 수 있다.



---

## 작게 시작하기: 스프링과 키클록으로 한 개의 엔드포인트 보호

---

## 키클록으로 조직 서비스 보호하기

--- 

## 마이크로서비스 보안을 마치며

