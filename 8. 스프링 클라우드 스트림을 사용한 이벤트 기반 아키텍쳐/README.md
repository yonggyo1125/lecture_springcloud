# 스프링 클라우드 스트림을 사용한 이벤트 기반 아키텍처
- 인간은 환경과 상호 작용할 때 항상 동적인 상태에 있다. 일반적으로 대화는 동기적이거나 선형적이지 않으며, 요청-응답 모델처럼 단순하게 정의되지도 않는다. 그것은 마치 우리가 주변 사물과 지속적으로 메시지를 주고받듯이 메시지가 주도하는 것처럼 보인다. 보통 메시지를 받으면 메시지에 반응하여 진행 중인 주요 작업을 중단할 때가 많다.

- 이 장에서는 비동기 메시지를 사용하여 다른 마이크로서비스와 통신하는 스프링 기반 마이크로서비스를 설계하고 구현하는 방법을 다룬다. 애플리케이션 간 통신에서 비동기식 메시지를 사용하는 것은 더 이상 새롭지 않다. 새로운 점은 메시지를 사용하여 상태 변경을 표현하는 이벤트로 통신한다는 개념이다. 이러한 개념을 <code>이벤트 기반 아키텍처(EDA, Event-Driven Architecture)</code> 또는 <code>메시지 기반 아키텍처(MDA, Message-Driven Architecture)</code>라고 한다. EDA 기반의 접근 방식으로 특정 라이브러리나 서비스에 밀접하게 결합하지 않고 변화에 대응할 수 있는 높은 수준의 분리된 시스템을 구축할 수 있다. 마이크로서비스를 통합할 때 EDA를 사용하면 애플리케이션에서 발송하는 이벤트(메시지) 스트림을 서비스는 수신만 하면 되기 때문에 애플리케이션에 새로운 기능을 빠르게 추가할 수 있다.

- 스프링 클라우드 프로젝트를 사용하면 <code>스프링 클라우드 스트림(Spring Cloud Stream)</code>이라는 하위 프로젝트를 이용하여 메시지 기반 솔루션을 손쉽게 구축할 수 있다. 스프링 클라우드 스트림은 하부 메시징 플랫폼과 연관된 세부 구현에서 서비스를 보호함으로써 메시지 발행(publish)과 소비(consume)를 쉽게 구현할 수 있게 한다.


## 메시징과 EDA, 마이크로서비스의 사례

- 마이크로서비스 기반 애플리케이션을 구축하는 데 왜 메시징이 중요할까? 이 질문에 답하기 위해 예제를 하나 살펴보자

- 운영 환경에 이 서비스들을 배포한 후 게시판 서비스에서 정보를 조회할 때  회원 서비스 호출이 지나치게 오래 걸린다는 것을 발견했다고 하자. 게시판 서비스 데이터의 사용 패턴을 살펴보면 게시판 데이터는 거의 변경이 없고 게시판 서비스에서 읽어 오는 대부분의 데이터가 게시판 레코드의 기본 키(primary key)로 수행된다는 것을 알 수 있었다. 데이터베이스 액세스 비용을 들이지 않고 게시판 데이터의 읽기를 캐싱할 수 있다면 회원 서비스에 대한 호출 응답 시간을 크게 향상시킬 수 있을 것이다. 캐싱 솔루션을 구현하려면 다음 세 가지 핵심 요구 사항을 고려해야 한다.
  - **캐싱된 데이터는 회원 서비스의 모든 인스턴스에 일관성이 있어야 한다**: 이것은 어떤 회원 서비스의 인스턴스에 접근하든 동일한 게시판 데이터 읽기가 보장되어야 하므로 회원 서비스 내에서 로컬로 데이터를 캐싱할 수 없다는 것을 의미한다.
  - **회원 서비스를 호스팅하는 컨테이너 메모리에 게시판 데이터를 캐싱하면 안 된다**: 서비스를 호스팅하는 런타임 컨테이너는 크기가 제한되어 있을 때가 많고, 다양한 액세스 패턴으로 데이터를 가져갈 수 있다. 로컬 캐싱은 클러스터 내 다른 서비스들과 동기화를 보장해야 하므로 복잡성을 유발한다.
  - **업데이트나 삭제로 게시판 레코드가 변경될 때 회원 서비스는 게시판 서비스의 상태 변화를 인식해야 한다**: 이 경우 회원 서비스는 특정 게시판의 캐싱된 데이터를 모두 무효화하고 캐시에서 제거해야 한다.  

- 이러한 요구 사항을 구현하는 두 가지 접근 방법이 있다. 
  - 첫 번째 방법은 동기식 요청-응답 모델로 요구 사항을 구현하는 것이다. 게시판 상태가 변경되면 회원과 게시판 서비스는 REST 엔드포인트를 이용하여 서로 통신한다. 
  - 두 번째 방법은 조직 서비스는 자기 데이터가 변경되었음을 알리려고 비동기 이벤트(메시지)를 발송하는 것이다. 이 방법을 사용하면 게시판 서비스는 게시판 레코드가 업데이트 또는 삭제(상태 변경)되었음을 나타내는 메시지를 큐에 발행한다. 회원 서비스는 중개자(메시지 브로커 또는 대기열)와 함께 수신하여 게시판 이벤트가 발생했는지 확인하고, 발생하면 캐시에서 조직 데이터를 삭제한다.

### 동기식 요청-응답 방식으로 상태 변화 전달

- 게시판 데이터의 캐시(cache)에 분산 키-값 저장소 데이터베이스인 레디스(Redis)(https://redis.io/)를 사용한다. 다음 그림은 레디스처럼 전통적인 동기식 요청-응답 프로그래밍 모델을 사용한 캐싱 솔루션 구축 방법을 개괄적으로 보여 준다.


---

## 스프링 클라우드 스트림 소개

---

## 간단한 메시지 생산자와 소비자 작성

---

## 스프링 클라우드 스트림 사용 사례: 분산 캐싱
